#!/usr/bin/env perl

use strict;
use warnings;
use WikiText::Socialtext::Parser;
use WikiText::HTML::Emitter;
use Getopt::Long;

my $html_already;

GetOptions(
    "html-already" => \$html_already,
);

my $input = do { local $/; <> };
$input =~ s/\r//g;
my $html = '';

$html = WikiText::Socialtext::Parser->new(
   receiver => WikiText::HTML::Emitter->new(
       callbacks => {
           wikilink => sub {
               my $node = shift;
               my $target = $node->{attributes}{target};
               return "$target/index.html";
           },
       },
   ),
)->parse($input);

if ($html_already) {
    print $html;
}
else {
    print <<"...";
[% WRAPPER wrapper.html %]
$html
[% END %]
...
}
